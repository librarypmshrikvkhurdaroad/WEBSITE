<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School Library</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-800">

<main class="max-w-6xl mx-auto p-4">
    <h1 class="text-3xl font-bold mb-6">Library Catalogue</h1>

    <!-- Search -->
    <div class="mb-6 flex gap-2">
      <input id="searchInput" class="p-2 border rounded flex-1" placeholder="Title, author or ISBN">
      <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>
    </div>

    <!-- Search Results -->
    <div id="searchResults" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8"></div>

    <!-- Full Catalogue -->
    <h2 class="text-2xl font-bold mb-4">All Books</h2>
    <div id="booksGrid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
</main>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

// ===== Supabase Setup =====
const supabase = createClient(
  "https://gtzmmhowtxvfrbdxpioh.supabase.co",  // Replace with your Supabase URL
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd0em1taG93dHh2ZnJiZHhwaW9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NzE4ODgsImV4cCI6MjA4MDU0Nzg4OH0.5Ys003VuHXLngvGQlKNJrDjQybs87H1Vs-hRGNuQPDo" // Replace with your Supabase anon key
);

// ===== Google Books API Key =====
const googleApiKey = "AIzaSyCJGgpA594gCg8eOVOpLkhKVcs5K7Jkg38";

// ===== Fetch book metadata from Google Books API =====
async function fetchBookMetadata(isbn) {
  const url = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&key=${googleApiKey}`;
  const res = await fetch(url);
  if (!res.ok) return null;
  const data = await res.json();
  if (!data.items || data.items.length === 0) return null;

  const info = data.items[0].volumeInfo;
  return {
    title: info.title || "No title",
    author: info.authors ? info.authors.join(", ") : "Unknown author",
    cover_url: (info.imageLinks && (info.imageLinks.thumbnail || info.imageLinks.smallThumbnail)) || "assets/placeholder.png",
    publishedDate: info.publishedDate || "",
    description: info.description || ""
  };
}

// ===== Load full catalogue from Supabase =====
async function loadCatalogue() {
  const grid = document.getElementById("booksGrid");
  grid.innerHTML = "<p>Loading...</p>";

  const { data, error } = await supabase.from("book_data").select("*");
  if (error) {
    grid.innerHTML = "<p class='text-red-600'>Error loading books</p>";
    console.error(error);
    return;
  }

  if (!data.length) {
    grid.innerHTML = "<p class='text-gray-600'>No books yet.</p>";
    return;
  }

  const booksMetadata = await Promise.all(
    data.map(async (b) => {
      const meta = await fetchBookMetadata(b.isbn);
      return { isbn: b.isbn, ...meta };
    })
  );

  grid.innerHTML = booksMetadata.map(b => `
    <div class="bg-white rounded shadow p-3">
      <img src="${b.cover_url}" class="w-full h-40 object-cover rounded">
      <h3 class="font-semibold mt-2">${b.title}</h3>
      <p class="text-sm text-gray-600">${b.author}</p>
      <p class="text-sm text-gray-600">ISBN: ${b.isbn}</p>
    </div>
  `).join("");
}

// ===== Search function =====
document.getElementById("searchBtn").addEventListener("click", async () => {
  const q = document.getElementById("searchInput").value.trim();
  const results = document.getElementById("searchResults");
  if (!q) { results.innerHTML = "<p class='text-gray-600'>Enter a query</p>"; return; }
  results.innerHTML = "<p>Searching...</p>";

  let books = [];
  // Search by ISBN
  if (/^\d{10,13}$/.test(q)) {
    const meta = await fetchBookMetadata(q);
    if (meta) books.push(meta);
  }

  // Search by title/author fallback
  if (books.length === 0) {
    const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(q)}&key=${googleApiKey}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data.items) {
      books = data.items.map(item => {
        const info = item.volumeInfo;
        return {
          title: info.title || "No title",
          author: info.authors ? info.authors.join(", ") : "Unknown author",
          cover_url: (info.imageLinks && info.imageLinks.thumbnail) || "assets/placeholder.png",
          publishedDate: info.publishedDate || ""
        };
      });
    }
  }

  if (!books.length) results.innerHTML = "<p class='text-gray-600'>No results found</p>";
  else results.innerHTML = books.map(b => `
    <div class="bg-white p-3 rounded shadow flex gap-3">
      <img src="${b.cover_url}" class="w-20 h-24 object-cover rounded">
      <div>
        <h3 class="font-semibold">${b.title}</h3>
        <p class="text-sm text-gray-600">${b.author}</p>
      </div>
    </div>
  `).join("");
});

// Load catalogue on page load
loadCatalogue();
</script>
</body>
</html>
